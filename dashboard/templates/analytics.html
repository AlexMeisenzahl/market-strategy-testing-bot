<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics - Market Strategy Testing Bot</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Analytics CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'profit': '#10b981',
                        'loss': '#ef4444',
                        'dark-bg': '#0f172a',
                        'dark-card': '#1e293b',
                        'dark-border': '#334155'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
    </style>
</head>
<body class="bg-dark-bg text-gray-100">
    
    <!-- Navigation -->
    <nav class="bg-dark-card border-b border-dark-border p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="/" class="text-xl font-bold">üìä Market Strategy Bot</a>
                <a href="/" class="text-gray-400 hover:text-white">Dashboard</a>
                <a href="/opportunities" class="text-gray-400 hover:text-white">Opportunities</a>
                <a href="/analytics" class="text-white font-semibold">Analytics</a>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto p-6">
        <div class="analytics-page">
          
          <!-- Header -->
          <div class="page-header mb-8">
            <h1 class="text-4xl font-bold mb-2">üìä Advanced Analytics Dashboard</h1>
            <p class="text-gray-400">Comprehensive performance and risk metrics for your trading strategies</p>
          </div>

          <!-- Regime-based slicing (Phase 7E) -->
          <section class="regime-filters mb-6">
            <div class="bg-dark-card rounded-lg p-6 border border-dark-border">
              <h2 class="text-xl font-bold mb-4">Regime Filters</h2>
              <p class="text-gray-400 text-sm mb-4">Slice analytics by time, volatility regime, or event window. Results and exports respect these filters.</p>
              <div class="flex flex-wrap gap-4 items-end">
                <div>
                  <label class="block text-xs text-gray-400 mb-1">Start date</label>
                  <input type="date" id="regime-start" class="bg-dark-bg border border-dark-border rounded px-3 py-2 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-1">End date</label>
                  <input type="date" id="regime-end" class="bg-dark-bg border border-dark-border rounded px-3 py-2 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-1">Volatility regime</label>
                  <select id="regime-volatility" class="bg-dark-bg border border-dark-border rounded px-3 py-2 text-sm">
                    <option value="">All</option>
                    <option value="low">Low</option>
                    <option value="med">Med</option>
                    <option value="high">High</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-1">Event window start</label>
                  <input type="date" id="regime-event-start" class="bg-dark-bg border border-dark-border rounded px-3 py-2 text-sm" placeholder="Optional">
                </div>
                <div>
                  <label class="block text-xs text-gray-400 mb-1">Event window end</label>
                  <input type="date" id="regime-event-end" class="bg-dark-bg border border-dark-border rounded px-3 py-2 text-sm" placeholder="Optional">
                </div>
                <button type="button" onclick="applyRegimeAndRefresh()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">Apply &amp; refresh</button>
              </div>
            </div>
          </section>
          
          <!-- Section 1: Strategy Performance Breakdown -->
          <section class="strategy-performance-section mb-8">
            <div class="bg-dark-card rounded-lg p-6 border border-dark-border">
              <h2 class="text-2xl font-bold mb-4">Strategy Performance Breakdown</h2>
              <div class="table-container overflow-x-auto">
                <table class="strategy-table w-full">
                  <thead>
                    <tr class="border-b border-dark-border">
                      <th class="p-3 text-left">Strategy</th>
                      <th class="p-3 text-right">Trades</th>
                      <th class="p-3 text-right">Win Rate</th>
                      <th class="p-3 text-right">Total P&L</th>
                      <th class="p-3 text-right">Avg Profit</th>
                      <th class="p-3 text-right">Profit Factor</th>
                      <th class="p-3 text-right">Largest Win</th>
                      <th class="p-3 text-right">Largest Loss</th>
                      <th class="p-3 text-right">Expectancy</th>
                      <th class="p-3 text-right">Max Consec Wins</th>
                      <th class="p-3 text-right">Recovery</th>
                    </tr>
                  </thead>
                  <tbody id="strategy-performance-body">
                    <tr>
                      <td colspan="11" class="p-6 text-center text-gray-400">Loading strategy performance...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
          
          <!-- Section 2: Risk Metrics Cards -->
          <section class="risk-metrics-section mb-8">
            <h2 class="text-2xl font-bold mb-4">Risk Metrics</h2>
            <div class="risk-cards-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
              <div class="risk-card bg-dark-card rounded-lg p-6 border border-dark-border">
                <h3 class="text-lg font-semibold mb-2">Sharpe Ratio</h3>
                <div class="metric-value text-4xl font-bold text-blue-400 mb-2" id="sharpe-ratio">--</div>
                <div class="benchmark text-sm text-gray-400">&gt;2.0 Excellent | 1-2 Good | &lt;1 Poor</div>
              </div>
              <div class="risk-card bg-dark-card rounded-lg p-6 border border-dark-border">
                <h3 class="text-lg font-semibold mb-2">Sortino Ratio</h3>
                <div class="metric-value text-4xl font-bold text-blue-400 mb-2" id="sortino-ratio">--</div>
                <div class="benchmark text-sm text-gray-400">&gt;3.0 Excellent | 1.5-3 Good | &lt;1.5 Poor</div>
              </div>
              <div class="risk-card bg-dark-card rounded-lg p-6 border border-dark-border">
                <h3 class="text-lg font-semibold mb-2">Max Drawdown</h3>
                <div class="metric-value text-4xl font-bold text-red-400 mb-2" id="max-drawdown">--</div>
                <div class="benchmark text-sm text-gray-400">&lt;10% Excellent | 10-20% Good | &gt;20% High Risk</div>
              </div>
              <div class="risk-card bg-dark-card rounded-lg p-6 border border-dark-border">
                <h3 class="text-lg font-semibold mb-2">VaR (95%)</h3>
                <div class="metric-value text-4xl font-bold text-yellow-400 mb-2" id="var-95">--</div>
                <div class="description text-sm text-gray-400">95% confident max loss</div>
              </div>
              <div class="risk-card bg-dark-card rounded-lg p-6 border border-dark-border">
                <h3 class="text-lg font-semibold mb-2">VaR (99%)</h3>
                <div class="metric-value text-4xl font-bold text-yellow-400 mb-2" id="var-99">--</div>
                <div class="description text-sm text-gray-400">99% confident max loss</div>
              </div>
              <div class="risk-card bg-dark-card rounded-lg p-6 border border-dark-border">
                <h3 class="text-lg font-semibold mb-2">Calmar Ratio</h3>
                <div class="metric-value text-4xl font-bold text-blue-400 mb-2" id="calmar-ratio">--</div>
                <div class="benchmark text-sm text-gray-400">&gt;3.0 Excellent | 1-3 Good | &lt;1 Poor</div>
              </div>
            </div>
            
            <!-- Drawdown Chart -->
            <div class="chart-container bg-dark-card rounded-lg p-6 border border-dark-border">
              <h3 class="text-xl font-semibold mb-4">Drawdown Over Time</h3>
              <canvas id="drawdown-chart"></canvas>
            </div>
          </section>
          
          <!-- Section 3: Time-Based Heatmaps -->
          <section class="time-analytics-section mb-8">
            <h2 class="text-2xl font-bold mb-4">Time-Based Performance</h2>
            
            <div class="bg-dark-card rounded-lg p-6 border border-dark-border mb-4">
              <h3 class="text-xl font-semibold mb-4">Profit by Hour of Day</h3>
              <div id="hour-heatmap" class="heatmap"></div>
            </div>
            
            <div class="bg-dark-card rounded-lg p-6 border border-dark-border mb-4">
              <h3 class="text-xl font-semibold mb-4">Profit by Day of Week</h3>
              <div id="day-heatmap" class="heatmap"></div>
            </div>
            
            <div class="best-times-card bg-dark-card rounded-lg p-6 border border-dark-border">
              <h3 class="text-xl font-semibold mb-4">üèÜ Best Trading Times</h3>
              <div id="best-times-list" class="text-gray-300">Loading...</div>
            </div>
          </section>
          
          <!-- Section 4: Market Performance -->
          <section class="market-analytics-section mb-8">
            <h2 class="text-2xl font-bold mb-4">Market Performance Analysis</h2>
            
            <div class="market-filters mb-4 flex space-x-2">
              <button class="filter-btn active px-4 py-2 rounded bg-blue-600 text-white" data-sort="total_pnl">By P&L</button>
              <button class="filter-btn px-4 py-2 rounded bg-gray-700 text-white hover:bg-gray-600" data-sort="win_rate">By Win Rate</button>
              <button class="filter-btn px-4 py-2 rounded bg-gray-700 text-white hover:bg-gray-600" data-sort="total_trades">By Volume</button>
            </div>
            
            <div class="market-tables grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div class="bg-dark-card rounded-lg p-6 border border-dark-border">
                <h3 class="text-xl font-semibold mb-4">üèÜ Top 10 Markets</h3>
                <div class="table-container overflow-x-auto">
                  <table class="market-table w-full">
                    <thead>
                      <tr class="border-b border-dark-border">
                        <th class="p-2 text-left">Market</th>
                        <th class="p-2 text-right">Trades</th>
                        <th class="p-2 text-right">Win Rate</th>
                        <th class="p-2 text-right">Total P&L</th>
                        <th class="p-2 text-right">Avg Profit</th>
                      </tr>
                    </thead>
                    <tbody id="top-markets-body">
                      <tr>
                        <td colspan="5" class="p-4 text-center text-gray-400">Loading markets...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div class="bg-dark-card rounded-lg p-6 border border-dark-border">
                <h3 class="text-xl font-semibold mb-4">‚ö†Ô∏è Worst 10 Markets</h3>
                <div class="table-container overflow-x-auto">
                  <table class="market-table w-full">
                    <thead>
                      <tr class="border-b border-dark-border">
                        <th class="p-2 text-left">Market</th>
                        <th class="p-2 text-right">Trades</th>
                        <th class="p-2 text-right">Win Rate</th>
                        <th class="p-2 text-right">Total P&L</th>
                        <th class="p-2 text-right">Avg Profit</th>
                      </tr>
                    </thead>
                    <tbody id="worst-markets-body">
                      <tr>
                        <td colspan="5" class="p-4 text-center text-gray-400">Loading markets...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
          
          <!-- Section 5: Export -->
          <section class="export-section bg-dark-card rounded-lg p-6 border border-dark-border">
            <h3 class="text-xl font-semibold mb-4">üì• Export Reports</h3>
            <p class="text-gray-400 text-sm mb-2">Exports use current regime filters (date range, volatility, event window).</p>
            <div class="flex gap-4">
              <button class="btn-export px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition" onclick="exportAnalytics('csv')">üìä Export CSV</button>
              <button class="btn-export px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition" onclick="exportAnalytics('json')">üìã Export JSON</button>
            </div>
          </section>
          
        </div>
    </div>
    
    <!-- Socket.IO for WebSocket support -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- NEW: Load notification and chart libraries -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css') }}">
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    
    <script src="{{ url_for('static', filename='js/analytics.js') }}"></script>
    
    <!-- Auto-refresh analytics every 30 seconds -->
    <script>
        setInterval(function() {
            fetch('/api/analytics')
                .then(r => r.json())
                .then(data => {
                    if (data && typeof updateAnalyticsData === 'function') {
                        updateAnalyticsData(data);
                    }
                })
                .catch(error => console.error('Analytics auto-refresh error:', error));
        }, 30000);
    </script>
</body>
</html>
